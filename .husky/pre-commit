#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” æ£€æŸ¥ä¾èµ–å’Œ overrides ä¸­æ˜¯å¦åŒ…å« link ä¾èµ–..."

# æ£€æŸ¥ package.json ä¸­çš„ dependencies å’Œ devDependencies
check_package_json() {
  if [ ! -f "package.json" ]; then
    return 0
  fi
  
  if command -v node >/dev/null 2>&1; then
    # ä½¿ç”¨ Node.js æ£€æŸ¥ package.json
    node -e "
      const fs = require('fs');
      const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
      const deps = { ...(pkg.dependencies || {}), ...(pkg.devDependencies || {}) };
      const linkDeps = Object.entries(deps)
        .filter(([_, v]) => typeof v === 'string' && (v.startsWith('link:') || v.startsWith('file:')))
        .map(([k, v]) => \`\${k}: \${v}\`);
      
      if (linkDeps.length > 0) {
        console.error('âŒ é”™è¯¯ï¼šåœ¨ package.json çš„ dependencies æˆ– devDependencies ä¸­å‘ç° link ä¾èµ–ï¼š');
        linkDeps.forEach(dep => console.error('   -', dep));
        process.exit(1);
      }
    " 2>&1
    
    if [ $? -ne 0 ]; then
      return 1
    fi
  else
    # å¦‚æœæ²¡æœ‰ Node.jsï¼Œä½¿ç”¨ grep æ£€æŸ¥
    if grep -E '"(link:|file:)' package.json >/dev/null 2>&1; then
      echo "âŒ é”™è¯¯ï¼šåœ¨ package.json ä¸­å‘ç° link æˆ– file ä¾èµ–"
      grep -E '"(link:|file:)' package.json | sed 's/^/   /'
      return 1
    fi
  fi
  
  return 0
}

# æ£€æŸ¥ pnpm-lock.yaml ä¸­çš„ overrides
check_pnpm_lock() {
  if [ ! -f "pnpm-lock.yaml" ]; then
    return 0
  fi
  
  # æ£€æŸ¥ overrides éƒ¨åˆ†æ˜¯å¦åŒ…å« link
  # åªæ£€æŸ¥ overrides éƒ¨åˆ†ï¼Œå› ä¸ºè¿™æ˜¯æœ¬åœ°å¼€å‘é…ç½®ï¼Œä¸åº”è¯¥æäº¤
  if grep -q "^overrides:" pnpm-lock.yaml; then
    # è·å– overrides éƒ¨åˆ†çš„å†…å®¹ï¼ˆä» overrides: åˆ°ä¸‹ä¸€ä¸ªé¡¶çº§é”®ä¹‹å‰ï¼‰
    local override_section=$(awk '/^overrides:/{flag=1} flag && /^[a-z]/{flag=0} flag' pnpm-lock.yaml)
    
    if echo "$override_section" | grep -E "link:" >/dev/null 2>&1; then
      echo "âŒ é”™è¯¯ï¼šåœ¨ pnpm-lock.yaml çš„ overrides ä¸­å‘ç° link ä¾èµ–ï¼š"
      echo "$override_section" | grep -E "link:" | sed 's/^/   /'
      return 1
    fi
  fi
  
  return 0
}

# æ‰§è¡Œæ£€æŸ¥
error_count=0

if ! check_package_json; then
  error_count=$((error_count + 1))
fi

if ! check_pnpm_lock; then
  error_count=$((error_count + 1))
fi

# å¦‚æœæœ‰é”™è¯¯ï¼Œé˜»æ­¢æäº¤
if [ $error_count -gt 0 ]; then
  echo ""
  echo "ğŸš« æäº¤è¢«é˜»æ­¢ï¼šæ£€æµ‹åˆ° link ä¾èµ–ï¼Œè¿™äº›ä¾èµ–ä¸åº”è¯¥æäº¤åˆ°ä»“åº“ã€‚"
  echo ""
  echo "ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š"
  echo "   1. ä» package.json ä¸­ç§»é™¤ link ä¾èµ–"
  echo "   2. ä» pnpm-lock.yaml çš„ overrides ä¸­ç§»é™¤ link é…ç½®"
  echo "   3. è¿è¡Œ 'pnpm install' é‡æ–°ç”Ÿæˆ pnpm-lock.yaml"
  echo ""
  exit 1
fi

echo "âœ… æ£€æŸ¥é€šè¿‡ï¼šæœªå‘ç° link ä¾èµ–"
exit 0

